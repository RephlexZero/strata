# Strata Platform — Full Dev Stack
#
# ── Fastest iteration (native Rust, auto-restart on save) ──────────
#
#   docker compose up -d postgres strata-receiver   # infra (once)
#
#   # Terminal 1 — control plane:
#   cargo watch -x 'run -p strata-control'
#
#   # Terminal 2 — sender agent:
#   cargo watch -x 'run -p strata-agent -- --control-url ws://localhost:3000/agent/ws --enrollment-token DEV1-TEST --hostname sim-sender-01'
#
# ── Full Docker stack (no cargo needed) ────────────────────────────
#
#   cargo build -p strata-gst -p strata-agent -p strata-control
#   docker compose up -d
#
# Dashboard:  http://localhost:3000
# Login:      dev@strata.local / development
#
# Web development (hot-reload, edit .rs/.css → auto-refresh):
#   docker compose --profile web-dev up --build dashboard-dev   # :8080
#   docker compose --profile web-dev up --build portal-dev      # :8081
#
# To stream to YouTube (or any RTMP target), set RELAY_URL:
#   RELAY_URL="rtmp://a.rtmp.youtube.com/live2/YOUR_STREAM_KEY" docker compose up -d
#
# Network Topology:
#   Three isolated bridge networks (link0/link1/link2) simulate bonded
#   cellular links.  tc netem impairments are applied at container start
#   via dev/entrypoint-sender.sh giving realistic cellular-grade
#   delay, jitter, loss, and rate-limiting (~3500 kbps aggregate).

services:
  # ── PostgreSQL ───────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: strata
      POSTGRES_USER: strata
      POSTGRES_PASSWORD: dev-only-password
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U strata"]
      interval: 3s
      timeout: 3s
      retries: 10

  # ── Control Plane (REST + WSS + Dashboard on :3000) ──────────
  strata-control:
    build:
      context: .
      dockerfile: dev/Dockerfile.control
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: "postgres://strata:dev-only-password@postgres/strata"
      LISTEN_ADDR: "0.0.0.0:3000"
      RUST_LOG: "info,strata_control=debug"
      DEV_SEED: "1"
      RECEIVER_HOST: "strata-receiver"
      # Per-link receiver IPs (one per Docker network, matching compose subnets)
      RECEIVER_LINKS: "172.30.0.20:5000,172.30.1.20:5002,172.30.2.20:5004"
    ports:
      - "3000:3000"
    restart: unless-stopped

  # ── Sender Agent (real GStreamer pipeline) ───────────────────
  #
  # Runs the strata-agent daemon.  The sender is attached to three
  # isolated Docker networks (link0, link1, link2) which give it
  # three genuine eth interfaces.  The entrypoint script applies
  # tc netem impairments modelled after realistic LTE/5G cellular
  # links before handing off to the agent binary.
  #
  # When a stream is started from the dashboard, the agent spawns
  # integration_node which builds a real GStreamer pipeline:
  # videotestsrc → x264enc → mpegtsmux → stratasink
  # sending over bonded transport links to the receiver.
  strata-sender-sim:
    build:
      context: .
      dockerfile: dev/Dockerfile.agent
    depends_on:
      - strata-control
      - strata-receiver
    cap_add:
      - NET_ADMIN
    environment:
      RUST_LOG: "info,strata_agent=debug"
      GST_PLUGIN_PATH: "/usr/lib/x86_64-linux-gnu/gstreamer-1.0"
      # Per-link tc netem impairment config (override to tune)
      # Format: RATE_KBIT DELAY_MS JITTER_MS LOSS_PERCENT
      LINK0_IMPAIRMENT: "8000 40 10 1.0"
      LINK1_IMPAIRMENT: "5000 60 15 2.0"
      LINK2_IMPAIRMENT: "6000 35 8 0.5"
    entrypoint: ["/usr/local/bin/entrypoint-sender.sh"]
    command:
      - "--control-url"
      - "ws://strata-control:3000/agent/ws"
      - "--enrollment-token"
      - "DEV1-TEST"
      - "--hostname"
      - "sim-sender-01"
      - "--heartbeat-interval"
      - "5"
    ports:
      - "3001:3001"
    networks:
      link0:
        ipv4_address: 172.30.0.10
      link1:
        ipv4_address: 172.30.1.10
      link2:
        ipv4_address: 172.30.2.10
      default: {}   # management — control plane access (no impairment)
    restart: unless-stopped

  # ── Receiver (bonded transport → RTMP relay) ─────────────────────
  #
  # Receives the bonded transport stream on UDP ports via stratasrc,
  # reassembles it, and relays to an RTMP destination.
  # Attached to same link networks as the sender so traffic flows
  # across the impaired paths.
  #
  # Set RELAY_URL to enable the relay:
  #   RELAY_URL="rtmp://a.rtmp.youtube.com/live2/YOUR_KEY" docker compose up -d
  #
  # Without RELAY_URL the receiver runs in monitor mode (logs packets).
  strata-receiver:
    build:
      context: .
      dockerfile: dev/Dockerfile.agent
    environment:
      RUST_LOG: "info"
      GST_PLUGIN_PATH: "/usr/lib/x86_64-linux-gnu/gstreamer-1.0"
      RELAY_URL: "${RELAY_URL:-}"
      STRATA_CODEC: "${STRATA_CODEC:-h265}"
      STRATA_LINK_COUNT: "3"
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        # Build bind URL from STRATA_LINK_COUNT (default 3)
        COUNT=$${STRATA_LINK_COUNT:-3}
        BIND=""
        for i in $$(seq 0 $$((COUNT - 1))); do
          PORT=$$((5000 + i * 2))
          if [ -n "$$BIND" ]; then BIND="$$BIND,"; fi
          BIND="$${BIND}0.0.0.0:$$PORT"
        done
        echo "=== Receiver: binding $$BIND (codec=$$STRATA_CODEC) ==="
        ARGS="--bind $$BIND --codec $${STRATA_CODEC:-h265}"
        if [ -n "$$RELAY_URL" ]; then
          echo "=== Receiver: relay → $$RELAY_URL ==="
          ARGS="$$ARGS --relay-url $$RELAY_URL"
        else
          echo "=== Receiver: monitor mode (set RELAY_URL to relay) ==="
        fi
        exec strata-node receiver $$ARGS
    ports:
      - "5000:5000/udp"
      - "5002:5002/udp"
      - "5004:5004/udp"
    networks:
      link0:
        ipv4_address: 172.30.0.20
      link1:
        ipv4_address: 172.30.1.20
      link2:
        ipv4_address: 172.30.2.20
      default: {}   # management — host access for RELAY_URL
    restart: unless-stopped

  # ── Dashboard Dev (hot-reload WASM) ──────────────────────────────
  #
  # Live-reloading Trunk dev server for the dashboard.
  # Source is bind-mounted — edit .rs / .css files and the browser
  # refreshes automatically.  API and WebSocket calls are proxied
  # to the control plane.
  #
  #   docker compose --profile web-dev up dashboard-dev
  #   open http://localhost:8080
  dashboard-dev:
    profiles: ["web-dev"]
    build:
      context: .
      dockerfile: dev/Dockerfile.web-dev
      args:
        CRATE: strata-dashboard
    depends_on:
      - strata-control
    ports:
      - "8080:8080"
    volumes:
      - ./crates/strata-dashboard/src:/src/crates/strata-dashboard/src
      - ./crates/strata-dashboard/style:/src/crates/strata-dashboard/style
      - ./crates/strata-dashboard/index.html:/src/crates/strata-dashboard/index.html:ro
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        cp index.html index.html.bak 2>/dev/null || true
        cat > Trunk.toml <<'EOF'
        [build]
        dist = "dist"

        [[hooks]]
        stage = "pre_build"
        command = "npx"
        command_arguments = ["@tailwindcss/cli", "-i", "style/input.css", "-o", "style/main.css", "--minify"]

        [[proxy]]
        rewrite = "/api/"
        backend = "http://strata-control:3000/api/"

        [[proxy]]
        rewrite = "/ws"
        backend = "ws://strata-control:3000/ws"
        ws = true
        EOF
        exec trunk serve --address 0.0.0.0 --port 8080
    restart: unless-stopped

  # ── Portal Dev (hot-reload WASM) ────────────────────────────────
  #
  # Live-reloading Trunk dev server for the sender portal.
  #
  #   docker compose --profile web-dev up portal-dev
  #   open http://localhost:8081
  portal-dev:
    profiles: ["web-dev"]
    build:
      context: .
      dockerfile: dev/Dockerfile.web-dev
      args:
        CRATE: strata-portal
    depends_on:
      - strata-sender-sim
    ports:
      - "8081:8080"
    volumes:
      - ./crates/strata-portal/src:/src/crates/strata-portal/src
      - ./crates/strata-portal/style:/src/crates/strata-portal/style
      - ./crates/strata-portal/index.html:/src/crates/strata-portal/index.html:ro
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        cat > Trunk.toml <<'EOF'
        [build]
        dist = "dist"

        [[hooks]]
        stage = "pre_build"
        command = "npx"
        command_arguments = ["@tailwindcss/cli", "-i", "style/input.css", "-o", "style/main.css", "--minify"]

        [[proxy]]
        rewrite = "/api/"
        backend = "http://strata-sender-sim:3001/api/"
        EOF
        exec trunk serve --address 0.0.0.0 --port 8080
    restart: unless-stopped

networks:
  # Three isolated bridge networks simulate independent cellular links.
  # Each has its own subnet and each container gets a real eth interface
  # per network.  tc netem impairments are applied on the sender's side
  # only (matching real-world: impairment is on the uplink from sender).
  link0:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/24
  link1:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.1.0/24
  link2:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.2.0/24

volumes:
  pgdata:
