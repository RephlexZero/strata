# ── Stage 1: Build portal WASM ───────────────────────────────
FROM rust:1.93-bookworm AS portal

# Node.js required for Tailwind CSS / DaisyUI pre-build hook
RUN curl -fsSL https://deb.nodesource.com/setup_22.x | bash - && \
    apt-get install -y --no-install-recommends nodejs && \
    rm -rf /var/lib/apt/lists/*

RUN rustup target add wasm32-unknown-unknown && \
    cargo install trunk --version 0.21.14

WORKDIR /src

COPY crates/strata-portal/Cargo.toml crates/strata-portal/Cargo.toml
COPY crates/strata-portal/src crates/strata-portal/src
COPY crates/strata-portal/index.html crates/strata-portal/index.html
COPY crates/strata-portal/style crates/strata-portal/style

# Trunk needs a workspace-like layout — create a minimal one
RUN cat > Cargo.toml <<'TOML'
[workspace]
resolver = "2"
members = ["crates/strata-portal"]
TOML

# Install Tailwind CSS + DaisyUI and build CSS, then build WASM with trunk
RUN cd crates/strata-portal && \
    npm init -y && npm install @tailwindcss/cli daisyui && \
    npx @tailwindcss/cli -i style/input.css -o style/main.css --minify && \
    trunk build --release

# ── Stage 2: Build GStreamer pipeline (integration_node + bonding plugin) ─
FROM rust:1.93-bookworm AS pipeline

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y --no-install-recommends \
    pkg-config clang \
    libgstreamer1.0-dev \
    libgstreamer-plugins-base1.0-dev \
    libgstreamer-plugins-bad1.0-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /src

# Copy Cargo.lock and workspace-level config
COPY Cargo.lock ./

# Copy only the crates needed for the pipeline build
COPY crates/strata-bonding crates/strata-bonding
COPY crates/strata-gst crates/strata-gst
COPY crates/strata-sim crates/strata-sim
COPY crates/strata-transport crates/strata-transport

# Write a minimal workspace manifest for just the pipeline crates
RUN cat > Cargo.toml <<'TOML'
[workspace]
resolver = "2"
members = [
    "crates/strata-bonding",
    "crates/strata-gst",
    "crates/strata-sim",
    "crates/strata-transport",
]

[workspace.dependencies]
gst = { package = "gstreamer", version = "0.24.4" }
gst-base = { package = "gstreamer-base", version = "0.24.4" }
gst-app = { package = "gstreamer-app", version = "0.24.4" }
serde = { version = "1.0.228", features = ["derive"] }
serde_json = "1.0.149"
toml = "0.9.8"
tracing = "0.1.44"
tracing-subscriber = { version = "0.3.22", features = ["env-filter"] }
anyhow = "1.0.101"
once_cell = "1.21.3"
bytes = "1.11.1"
crossbeam-channel = "0.5.15"
arc-swap = "1.7"
compact_str = "0.8"
rtrb = "0.3"
raptorq = "2.0"
rand = "0.10.0"
monoio = "0.2"
quanta = "0.12"

[profile.release]
lto = true
codegen-units = 1
panic = "abort"
TOML

# Build integration_node binary AND libgststrata.so plugin
RUN cargo build --release -p strata-gst

# ── Stage 3: Build strata-agent ──────────────────────────────
FROM rust:1.93-bookworm AS builder

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y --no-install-recommends \
    pkg-config \
    libssl-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /src

# Write a minimal workspace manifest (avoids needing GStreamer deps)
COPY Cargo.lock ./
COPY crates/strata-common/Cargo.toml crates/strata-common/Cargo.toml
COPY crates/strata-agent/Cargo.toml crates/strata-agent/Cargo.toml

RUN cat > Cargo.toml <<'TOML'
[workspace]
resolver = "2"
members = ["crates/strata-common", "crates/strata-agent"]

[workspace.dependencies]
tracing = "0.1.44"
tracing-subscriber = { version = "0.3.22", features = ["env-filter"] }
anyhow = "1.0.101"
serde = { version = "1.0.228", features = ["derive"] }
serde_json = "1.0.149"
toml = "0.9.8"
TOML

# Stub out sources for dep caching
RUN mkdir -p crates/strata-common/src && echo "" > crates/strata-common/src/lib.rs && \
    mkdir -p crates/strata-agent/src && echo "fn main() {}" > crates/strata-agent/src/main.rs

# Pre-build deps
RUN cargo build --release -p strata-agent 2>/dev/null || true

# Copy real source
COPY crates/strata-common/src crates/strata-common/src
COPY crates/strata-agent/src crates/strata-agent/src

# Build for real
RUN touch crates/strata-common/src/lib.rs crates/strata-agent/src/main.rs && \
    cargo build --release -p strata-agent

# ── Stage 4: Runtime ────────────────────────────────────────
FROM debian:12-slim

RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    iproute2 \
    gstreamer1.0-plugins-base \
    gstreamer1.0-plugins-good \
    gstreamer1.0-plugins-bad \
    gstreamer1.0-plugins-ugly \
    gstreamer1.0-libav \
    gstreamer1.0-tools \
    libgstreamer1.0-0 \
    && rm -rf /var/lib/apt/lists/*

# Agent binary
COPY --from=builder /src/target/release/strata-agent /usr/local/bin/strata-agent

# Pipeline binary + GStreamer bonding plugin
COPY --from=pipeline /src/target/release/strata-node /usr/local/bin/strata-node
COPY --from=pipeline /src/target/release/libgststrata.so /usr/lib/x86_64-linux-gnu/gstreamer-1.0/libgststrata.so

# Entrypoint script (applies tc netem impairments before starting agent)
COPY dev/entrypoint-sender.sh /usr/local/bin/entrypoint-sender.sh

# Portal WASM app
COPY --from=portal /src/crates/strata-portal/dist /app/portal

ENV PORTAL_DIR=/app/portal
ENV GST_PLUGIN_PATH=/usr/lib/x86_64-linux-gnu/gstreamer-1.0

EXPOSE 3001

ENTRYPOINT ["strata-agent"]
