# Session Summary — 2026-02-11

## Goals

1. **Implement the full AIMD bandwidth-adaptation design** from `docs/bandwidth-adaptation-design.md` into the DWRR scheduler.
2. **Release v0.3.0** with the AIMD feature.
3. **Build an integration test** verifying bandwidth differentiation across three bonded RIST links with distinct capacities (500 / 1200 / 1750 kbps ratio).

## Completed Work

### 1. AIMD Capacity Estimator (v0.3.0)

Implemented the delay-gradient + loss-based multiplicative-decrease congestion control system in `rist-bonding-core`:

- **`scheduler/dwrr.rs`** — Full AIMD state machine per link: additive increase on clean RTT, multiplicative decrease on loss or rising delay-gradient, cooldown guard, configurable α/β/thresholds.
- **`stats.rs`** — Extended stats schema (v3) with `estimated_capacity_bps`, `delay_gradient_ms`, `loss_rate`, `aimd_state` per link.
- **`config.rs`** — `AimdConfig` struct with tuneable parameters.
- 13 AIMD-specific unit tests + 157 total core tests passing.
- Fixed clippy `large_enum_variant` warning (`RuntimeMessage::ApplyConfig(Box<BondingConfig>)`).
- Tagged and pushed as **v0.3.0**.

### 2. TBF Bandwidth Enforcement in `rist-network-sim`

Discovered that `tc netem rate Xkbit` only adds serialization delay — it does **not** drop excess packets, so it cannot enforce actual bandwidth limits. Rewrote `apply_impairment()`:

- Added `tbf_shaping: bool` field to `ImpairmentConfig`.
- When `tbf_shaping = true`: installs a **TBF (Token Bucket Filter)** qdisc as root for real rate enforcement, with netem chained as a child for delay/loss/etc.
- When `tbf_shaping = false` (default): passes `rate_kbit` to netem's `rate` parameter (old behaviour), preserving compatibility with existing AIMD convergence tests that rely on RTCP feedback.
- TBF parameters: burst = `max(rate_bytes/10, 1540)`, latency = `1s` (absorbs video I-frame bursts).

### 3. Three-Link Bandwidth Differentiation Test

New integration test `test_three_link_bandwidth_differentiation` in `impaired_e2e.rs`:

- Creates 3 veth pairs between sender/receiver namespaces at 5 / 12 / 17.5 Mbps (TBF-enforced).
- Runs a 20-second bonded RIST video stream.
- Verifies via `tc -s` stats that TBF throughput ordering matches link bandwidth ordering.
- Asserts all 3 links are alive and carrying traffic.

### Key Architectural Finding

**librist sender-side stats measure application send rate** (bytes written to the kernel socket), **not wire rate**. TBF drops happen in the kernel qdisc and are invisible to userspace. AIMD convergence in end-to-end tests requires RTCP NACK feedback from the receiver, which the bonded receiver topology does not currently produce on a per-link basis. This is documented in the test and explains why the `tbf_shaping` opt-in flag was necessary.

## Files Changed

| File | Change |
|------|--------|
| `crates/rist-network-sim/src/impairment.rs` | `tbf_shaping` field + TBF/netem chain logic |
| `crates/gst-rist-bonding/tests/impaired_e2e.rs` | New `test_three_link_bandwidth_differentiation` |
| `docs/session-2026-02-11.md` | This summary |

## Test Results

- **157 unit tests**: all passing
- **4 rist-network-sim tests**: all passing
- **3 impaired_e2e integration tests**: all passing (step_change, 3-link, impaired_bonding)
- Pre-commit hooks (rustfmt + clippy): clean
